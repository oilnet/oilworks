% LaTeX style sheet for theses at the Oriental Institut, University of Leipzig.
% Based on jackson13's mla13 style designed for the Modern Language Association's
% style guidelines (see https://github.com/jackson13info/mla13).

\ProvidesPackage{oilworks}
\hfuzz=100pt
\vfuzz=100pt
\hbadness=100000
\vbadness=100000

\usepackage{todonotes}
\newcommand{\tabletodo}[3][]{\begin{minipage}{#2}\todo[inline,#1]{#3}\end{minipage}}

\usepackage[a4paper]{geometry} % changed from letterpaper.
\usepackage[british]{babel}
\usepackage[ngerman]{datetime} % for first page only! 
\usepackage{csquotes}
\usepackage{courier}
\setlength{\parindent}{0em} % changed from 0.5em. 0.75cm is good for no parskip.

\usepackage[
  citestyle=authoryear-icomp,
  bibstyle=authoryear,
  backend=biber,
  hyperref=true,
  sorting=nyt,
  ibidpage=true,
  dashed=true,
  mergedate=maximum,
  mincrossrefs=1,
]{biblatex}
% \renewcommand*{\mkibid}{\emph}

\usepackage{color}
\usepackage{multicol}
\newcommand{\sources}[1]{\def\@sources{#1}\bibliography{#1}}

% formatting Commands

\renewcommand \thesection {\@arabic\c@section.}
\renewcommand\thesubsection {\thesection\@arabic\c@subsection}

% this changes section headings.

\renewcommand\section{\@startsection{section}{1}{\z@}%
{\z@}%
{\lineskip}}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
{\z@}%
{\lineskip}}
\renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
{\z@}%
{\lineskip}}

% changed 1.5ex to 3.5ex.

\def\section{\@startsection{section}{1}{\z@}{-5.25ex plus -1ex minus -.2ex}{3.5ex plus .2ex}{\center\large\textbf}} % \newpage
\def\subsection{\@startsection{subsection}{1}{\z@}{-4.25ex plus -1ex minus -.2ex}{0.5ex plus .2ex}{\large\textbf}}
\def\subsubsection{\@startsection{subsubsection}{1}{\z@}{-4.25ex plus -1ex minus -.2ex}{0.5ex plus .2ex}{\large\textbf}}
\def\thesection{\arabic{section}}
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
{\z@}%
{\lineskip}%
{\normalfont}}
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{\parindent}%
{\z@}%
{\lineskip}%
{\normalfont}}
\usepackage{datetime}
\usepackage{fancyhdr}
\newcommand{\university}[1]{
\def\@university{#1}
}
\newcommand{\faculty}[1]{
\def\@faculty{#1}
}
\newcommand{\institute}[1]{
\def\@institute{#1}
}
\newcommand{\typeofwork}[1]{
\def\@typeofwork{#1}
}
\newcommand{\firstassessor}[1]{
\def\@firstassessor{#1}
}
\newcommand{\secondassessor}[1]{
\def\@secondassessor{#1}
}
\newcommand{\matriculationnumber}[1]{
\def\@matriculationnumber{#1}
}
\newcommand{\emailaddress}[1]{
\def\@emailaddress{#1}
}
\newcommand{\streetandhousenumber}[1]{
\def\@streetandhousenumber{#1}
}
\newcommand{\postcodeandcity}[1]{
\def\@postcodeandcity{#1}
}
\newcommand{\workperiodstart}[1]{
\def\@workperiodstart{#1}
}
\newcommand{\workperiodend}[1]{
\def\@workperiodend{#1}
}

% things needed beyond what mla13 provided.

\usepackage{titling}
\usepackage{url}
\urlstyle{same}
\usepackage{xcolor}
\usepackage{colortbl}

\definecolor{lightgray}{rgb}{0.95,0.95,0.95}
\definecolor{mediumgray}{rgb}{0.8,0.8,0.8}
\definecolor{darkgray}{rgb}{0.25,0.25,0.25}
\definecolor{black}{rgb}{0,0,0}
\definecolor{navyblue}{rgb}{0.2,0.2,0.6}

\usepackage[
  colorlinks=true, % light 'em up!
  citecolor=black, % biblatex citations.
  linkcolor=red,   % footnote numbers.
  filecolor=red,   % links to local files.
  urlcolor=red,    % links to websites.
]{hyperref}
\usepackage{import}
\usepackage{tocstyle}
\usepackage[nottoc,numbib]{tocbibind}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{blindtext}

\usepackage[section]{minted}
\usepackage{mdframed}
\newmintedfile[rubycode]{ruby}{
  bgcolor=lightgray,
  fontsize=\tiny,
  linenos=true,
  numberblanklines=true,
  numbersep=12pt,
  numbersep=5pt,
  gobble=0,
  frame=leftline,
  framerule=0.4pt,
  framesep=4mm,
  funcnamehighlighting=true,
  tabsize=2,
  obeytabs=false,
  mathescape=false,
  samepage=true,
  showspaces=false,
  showtabs=false,
  texcl=false,
}
\usepackage{pdfpages}
\usepackage{array}
\usepackage{longtable}
\usepackage{placeins}
\usepackage{wrapfig}
\usepackage{geometry}

\usepackage{paralist}
\renewenvironment{itemize}[1]{\begin{compactitem}#1}{\end{compactitem}}
\renewenvironment{enumerate}[1]{\begin{compactenum}#1}{\end{compactenum}}

\usepackage{fontspec}
\usepackage{float}
\usepackage{polyglossia} % also loads bidi!
\setmainlanguage[variant=british]{english} % parameter gehört ins Hauptdokument, nicht den Stil.
\setotherlanguage{arabic}
\newfontfamily\arabicfont[Script=Arabic,Scale=1.1]{Amiri}
\usepackage{setspace}
\onehalfspacing

% redefine \textarabic{} to always be upright

\let\oldtextarabic\textarabic
\renewcommand{\textarabic}{\upshape\oldtextarabic}

% redefine \textarabic{} to have bigger linespacing to accomodate the taškīl.

\def\ara{\doublespacing\textarabic}
\sources{\jobname.bib}
\setmainfont[Ligatures=TeX]{Charis SIL}
\setmonofont{Courier New}
\setsansfont{DejaVu Sans}
\newcommand{\latin}[1]{{\emph{#1}}} % for easier handling of how latin phrases are formatted.
\newcommand{\dmg}[1]{{\emph{#1}}} % the same for DMG transliteration.
\newcolumntype{J}[1]{>{\arraybackslash}p{#1}}
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}
\newcolumntype{M}[1]{>{\color{gray}\raggedright\arraybackslash}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}
% monospaced font for code, etc.
\def\code#1{\texttt{#1}}

% separate multiple consecutive footnotes by comma automatically,
% or provide a means to doing so manually should the first not work.
%\usepackage[multiple]{footmisc}
\newcommand\fnsep{\textsuperscript{,}}

% footnotes without marker
\newcommand\blindfootnote[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

% back to stuff that was once mla13.

\fancyhf{}
\fancyhead{}
\renewcommand{\headrulewidth}{0pt}
\geometry{top=3cm,bottom=3cm,left=2.5cm,right=2.5cm} % changed from 1in for all four sides.
\usepackage[absolute]{textpos}
\usepackage{parcolumns}
\newcommand*{\makeheader}{\begin{titlepage}
  \begin{center}
  \pagestyle{empty}
  \selectlanguage{german}
  \begingroup
    {\LARGE \@university} \\
    {\normalsize \@faculty} \\
    {\Large \@institute} \\
  \endgroup
  \vspace*{0.5cm}
  \includegraphics[height=150pt,width=150pt]{oilworks/uofl_official_seal}\\
  \vspace*{0.35cm}
  \begingroup
    {\LARGE \@typeofwork} \\
  \endgroup
  \vspace*{1.25cm}
  \begingroup
    {\LARGE \@title} \\
    {\normalsize \textit{\@subtitle}} \\
  \endgroup
  \vspace*{1.25cm}
  \small
  \begingroup
    1. Gutachter: \@firstassessor \\
    2. Gutachter: \@secondassessor \\
  \endgroup
  \vspace*{1.25cm}
  \begin{textblock*}{50mm}(30mm,228mm)
  \begin{flushleft}
  \begingroup
    Vorgelegt von \\
    \@author \\
    Matrikel-Nr.: \@matriculationnumber \\
    \@emailaddress \\
    \@streetandhousenumber \\
    \@postcodeandcity \\
    am \@date \\
  \endgroup
  \end{flushleft}
  \end{textblock*}
  \vspace*{1.25cm}
  \begin{textblock*}{50mm}(142mm,258mm)
  \begin{flushleft}
  \begingroup
    Bearbeitungszeitraum: \\
    \@workperiodstart--\@workperiodend
  \endgroup
  \end{flushleft}
  \end{textblock*}
  \selectlanguage{english} % parameter gehört ins Hauptdokument, nicht den Stil.
  \end{center}
\end{titlepage}
\clearpage
}
\newcommand*{\makeworkscited}{\begingroup
\pagebreak
\singlespacing
\addcontentsline{toc}{section}{Works Cited}
\setlength{\bibitemsep}{\parskip} % make bibliography more readable.
\printbibliography[title=Works Cited]
\onehalfspacing
\endgroup}

% scrartcl seems to have a slightly larger font in tables for some reason - reverse this.

\let\oldlongtable\longtable
\renewcommand{\longtable}{\small\oldlongtable}

% citation command for the full name (first and last) of the author.

\DeclareCiteCommand{\citeauthorfull}%
  {\boolfalse{citetracker}%
   \boolfalse{pagetracker}%
   \DeclareNameAlias{labelname}{first-last}%
   \usebibmacro{prenote}}%
  {\ifciteindex%
     {\indexnames{labelname}}%
     {}%
   \printnames{labelname}}%
  {\multicitedelim}%
  {\usebibmacro{postnote}}

% add f. for a single following, and ff. for multiple following pages.
% also don't prefix with p. or pp.
 
\renewcommand*{\postnotedelim}{\addcolon}
\DeclareFieldFormat{postnote}{#1}
\DeclareFieldFormat{multipostnote}{#1}
\renewcommand*{\sqspace}{}
\DefineBibliographyStrings{english}{%
  sequens = {f\adddot},
  sequentes = {ff\adddot},
}
\renewcommand*{\multicitedelim}{\addsemicolon\space}

% some convenience citation commands.
% italic instead of quotes for titles.

\DeclareFieldFormat*{citetitle}{\emph{#1}}
\newcommand{\parencitetitle}[1]{(\citetitle{#1})}
\newcommand{\citeauthoryear}[1]{\citeauthor{#1} (\citeyear{#1})}
\newcommand{\citetitleauthor}[1]{\citetitle{#1} \parencite{#1}}

% moewe's suggestion of instead adapting the \cite command.

\makeatletter
\renewbibmacro*{cite}{%
\ifboolexpr{test {\ifentrytype{inreference}} and not test {\iffieldundef{crossref}}}
  {\entrydata{\thefield{crossref}}{%
     \printfield{shorthand}}%
   \setunit{\addcolon\space}%
   \usebibmacro{cite:label}}%
  {%
  \iffieldundef{shorthand}
    {\ifthenelse{\ifciteibid\AND\NOT\iffirstonpage}
       {\usebibmacro{cite:ibid}}
       {\ifthenelse{\ifnameundef{labelname}\OR\iffieldundef{labelyear}}
          {\usebibmacro{cite:label}%
           \setunit{\addspace}%
           \usebibmacro{cite:labelyear+extrayear}%
           \usebibmacro{cite:reinit}}
          {\iffieldequals{namehash}{\cbx@lasthash}
             {\ifthenelse{\iffieldequals{labelyear}{\cbx@lastyear}\AND
                          \(\value{multicitecount}=0\OR\iffieldundef{postnote}\)}
                {\setunit{\addcomma}%
                 \usebibmacro{cite:extrayear}}
                {\setunit{\compcitedelim}%
                 \usebibmacro{cite:labelyear+extrayear}%
                 \savefield{labelyear}{\cbx@lastyear}}}
             {\printnames{labelname}%
              \setunit{\nameyeardelim}%
              \usebibmacro{cite:labelyear+extrayear}%
              \savefield{namehash}{\cbx@lasthash}%
              \savefield{labelyear}{\cbx@lastyear}}}}}
    {\usebibmacro{cite:shorthand}%
     \usebibmacro{cite:reinit}}}%
  \setunit{\multicitedelim}}
\makeatother

% cause tables and figures to be centered

\makeatletter
\g@addto@macro\@floatboxreset\centering
\makeatother

% combined list of figures and tables
% see http://tex.stackexchange.com/questions/258501/how-to-make-a-combined-list-of-figures-and-tables/258516#258516

\usepackage[titles]{tocloft}
\newlistof{figuresandtables}{loft}{List of figures and tables}
\makeatletter
% Change the file extension of both lot and lof
\def\ext@figure{loft}
\def\ext@table{loft}
% Store the original `\thefigure` and `\thetable`
\let\tohe@thefigure\thefigure
\let\tohe@thetable\thetable
% Redefine them to contain a "dummy" `\tohe@list...`
\def\thefigure{\tohe@listfig\tohe@thefigure}
\def\thetable{\tohe@listtab\tohe@thetable}
% Make the two dummy commands truly dummy
\let\tohe@listfig\relax
\let\tohe@listtab\relax
% Store the original `\listoffiguresandtables`
\let\tohe@listoffiguresandtables\listoffiguresandtables
% Redefine it in such a way that the dummy commands insert "Fig." or "Tab." respectively
\def\listoffiguresandtables{%
  \begingroup
  \addcontentsline{toc}{section}{List of figures and tables}
  \def\tohe@listfig{Figure~}
  \def\tohe@listtab{Table~}
  \tohe@listoffiguresandtables
  \endgroup  
}
% Change \listoffiguresandtables spacing
\setlength{\cftfignumwidth}{5.5em}
\setlength{\cfttabnumwidth}{5.5em}
\setlength{\cftfigindent}{1pt}
\setlength{\cfttabindent}{0pt}
\makeatother

% autoref settings

\usepackage{catoptions}
\makeatletter

\def\subsubsectionautorefname{chapter}
\def\subsectionautorefname{chapter}
\def\sectionautorefname{chapter}
\def\figureautorefname{figure}
\def\tableautorefname{table}
\def\appendixautorefname{appendix}

\def\Autoref#1{%
  \begingroup
  \edef\reserved@a{\cpttrimspaces{#1}}%
  \ifcsndefTF{r@#1}{%
    \xaftercsname{\expandafter\testreftype\@fourthoffive}
      {r@\reserved@a}.\\{#1}%
  }{%
    \ref{#1}%
  }%
  \endgroup
}
\def\testreftype#1.#2\\#3{%
  \ifcsndefTF{#1autorefname}{%
    \def\reserved@a##1##2\@nil{%
      \uppercase{\def\ref@name{##1}}%
      \csn@edef{#1autorefname}{\ref@name##2}%
      \autoref{#3}%
    }%
    \reserved@a#1\@nil
  }{%
    \autoref{#3}%
  }%
}
\makeatother
